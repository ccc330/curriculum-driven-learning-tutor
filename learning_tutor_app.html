<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>课程主导型学习导师</title>
    <!-- 引入Markdown解析库 -->
    <script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"></script>
    <!-- 引入代码高亮库 -->
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            height: 100vh;
            overflow: hidden;
        }

        .app-container {
            display: grid;
            grid-template-columns: 250px 1fr;
            height: 100vh;
            gap: 10px;
            padding: 10px;
        }

        .sidebar {
            background: #ffffff;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .btn-primary {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s;
        }

        .btn-primary:hover {
            background: #0056b3;
        }

        .conversation-list {
            flex-grow: 1;
            overflow-y: auto;
        }

        .conversation-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
        }

        .conversation-item:hover {
            background: #f5f5f5;
        }

        .conversation-item.active {
            background: #e3f2fd;
            font-weight: bold;
        }

        .main-content {
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: #ffffff;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .chat-window {
            flex-grow: 1;
            overflow-y: auto;
            overflow-x: hidden;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: #fff;
            display: flex;
            flex-direction: column;
            gap: 15px;
            scroll-behavior: smooth;
            max-height: calc(100vh - 200px);
        }

        .chat-window::-webkit-scrollbar {
            width: 8px;
        }

        .chat-window::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .chat-window::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        .chat-window::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* Firefox滚动条样式 */
        .chat-window {
            scrollbar-width: thin;
            scrollbar-color: #c1c1c1 #f1f1f1;
        }

        .message {
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 18px;
            line-height: 1.5;
        }

        .user-message {
            align-self: flex-end;
            background: #007bff;
            color: white;
            border-bottom-right-radius: 4px;
        }

        .assistant-message {
            align-self: flex-start;
            background: #f1f1f1;
            color: #333;
            border-bottom-left-radius: 4px;
        }

        .system-message {
            align-self: center;
            background: #e9ecef;
            color: #6c757d;
            font-size: 0.9em;
            border-radius: 12px;
        }

        .file-upload {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 0;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            border: none;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .file-preview {
            font-size: 0.9em;
            color: #6c757d;
        }

        .message-input {
            display: flex;
            gap: 10px;
            padding-top: 10px;
        }

        .message-input textarea {
            flex-grow: 1;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
            resize: none;
            height: 60px;
        }

        .message-input button {
            align-self: flex-end;
            padding: 10px 20px;
        }

        .status-indicator {
            display: none;
            font-size: 0.9em;
            color: #6c757d;
            padding: 5px 0;
        }

        .typing-indicator {
            display: flex;
            align-self: flex-start;
            background: #f1f1f1;
            padding: 10px 15px;
            border-radius: 18px;
            border-bottom-left-radius: 4px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background-color: #6c757d;
            border-radius: 50%;
            margin: 0 2px;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-5px); }
        }

        /* 滚动控制按钮 */
        .scroll-controls {
            position: absolute;
            right: 20px;
            bottom: 80px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            z-index: 10;
        }

        .scroll-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: rgba(0, 123, 255, 0.8);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .scroll-btn:hover {
            background: rgba(0, 123, 255, 1);
            transform: scale(1.1);
        }

        .scroll-btn:active {
            transform: scale(0.95);
        }

        .scroll-btn:disabled {
            cursor: not-allowed;
            opacity: 0.3 !important;
        }

        .scroll-btn:disabled:hover {
            transform: none;
            background: rgba(0, 123, 255, 0.8);
        }

        .main-content {
            position: relative;
        }

        /* Markdown渲染样式 */
        .message.markdown-content h1,
        .message.markdown-content h2,
        .message.markdown-content h3,
        .message.markdown-content h4,
        .message.markdown-content h5,
        .message.markdown-content h6 {
            margin: 16px 0 8px 0;
            font-weight: bold;
            line-height: 1.25;
        }

        .message.markdown-content h1 {
            font-size: 1.5em;
            border-bottom: 1px solid #eaecef;
            padding-bottom: 8px;
        }

        .message.markdown-content h2 {
            font-size: 1.3em;
            border-bottom: 1px solid #eaecef;
            padding-bottom: 6px;
        }

        .message.markdown-content h3 {
            font-size: 1.2em;
        }

        .message.markdown-content h4 {
            font-size: 1.1em;
        }

        .message.markdown-content p {
            margin: 8px 0;
            line-height: 1.6;
        }

        .message.markdown-content ul,
        .message.markdown-content ol {
            margin: 8px 0;
            padding-left: 20px;
        }

        .message.markdown-content li {
            margin: 4px 0;
            line-height: 1.5;
        }

        .message.markdown-content blockquote {
            margin: 8px 0;
            padding: 8px 16px;
            border-left: 4px solid #dfe2e5;
            background-color: #f6f8fa;
            color: #6a737d;
        }

        .message.markdown-content code {
            background-color: rgba(27, 31, 35, 0.05);
            border-radius: 3px;
            font-size: 85%;
            margin: 0;
            padding: 2px 4px;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
        }

        .message.markdown-content pre {
            background-color: #f6f8fa;
            border-radius: 6px;
            font-size: 85%;
            line-height: 1.45;
            overflow: auto;
            padding: 16px;
            margin: 8px 0;
        }

        .message.markdown-content pre code {
            background-color: transparent;
            border: 0;
            display: inline;
            line-height: inherit;
            margin: 0;
            max-width: auto;
            overflow: visible;
            padding: 0;
            word-wrap: normal;
        }

        .message.markdown-content table {
            border-collapse: collapse;
            margin: 8px 0;
            width: 100%;
        }

        .message.markdown-content table th,
        .message.markdown-content table td {
            border: 1px solid #dfe2e5;
            padding: 6px 13px;
        }

        .message.markdown-content table th {
            background-color: #f6f8fa;
            font-weight: bold;
        }

        .message.markdown-content strong {
            font-weight: bold;
        }

        .message.markdown-content em {
            font-style: italic;
        }

        .message.markdown-content hr {
            border: none;
            border-top: 1px solid #eaecef;
            margin: 16px 0;
        }

        /* 确保用户消息中的Markdown也能正确显示 */
        .user-message.markdown-content {
            color: white;
        }

        .user-message.markdown-content h1,
        .user-message.markdown-content h2 {
            border-bottom-color: rgba(255, 255, 255, 0.3);
        }

        .user-message.markdown-content blockquote {
            border-left-color: rgba(255, 255, 255, 0.3);
            background-color: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.9);
        }

        .user-message.markdown-content code {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .user-message.markdown-content pre {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .user-message.markdown-content table th,
        .user-message.markdown-content table td {
            border-color: rgba(255, 255, 255, 0.3);
        }

        .user-message.markdown-content table th {
            background-color: rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- 侧边栏 -->
        <div class="sidebar">
            <button id="new-conversation" class="btn-primary">新建对话</button>
            <div class="conversation-list" id="conversation-list">
                <!-- 对话历史列表 -->
            </div>
        </div>
        
        <!-- 主内容区 -->
        <div class="main-content">
            <!-- 聊天窗口 -->
            <div class="chat-window" id="chat-window">
                <!-- 消息会在这里显示 -->
                <div class="assistant-message message">
                    你好！我是你的课程主导型学习导师。请提供你要学习的教材内容，我将为你规划学习路径并带领你完成整个学习过程。
                </div>
            </div>
            
            <!-- 状态指示器 -->
            <div class="status-indicator" id="status-indicator">
                <div class="typing-indicator">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            </div>
            
            <!-- 文件上传区域 -->
            <div class="file-upload">
                <input type="file" id="file-input" hidden>
                <label for="file-input" class="btn-secondary">📁 上传文件</label>
                <div class="file-preview" id="file-preview"></div>
            </div>
            
            <!-- 消息输入区域 -->
            <div class="message-input">
                <textarea id="message-box" placeholder="输入您的问题..."></textarea>
                <button id="send-btn" class="btn-primary">发送</button>
            </div>

            <!-- 滚动控制按钮 -->
            <div class="scroll-controls" id="scroll-controls">
                <button class="scroll-btn" id="scroll-to-top" title="滚动到顶部 (Ctrl+Home)">↑</button>
                <button class="scroll-btn" id="scroll-to-bottom" title="滚动到底部 (Ctrl+End)">↓</button>
            </div>
        </div>
    </div>

    <script>
        // 简单的API客户端模拟
        class ApiClient {
            constructor() {
                this.baseURL = 'http://localhost:5000/api';
                this.conversations = [];
                this.currentConversationId = null;
            }

            // 开始新对话
            async startNewConversation() {
                try {
                    const response = await fetch(`${this.baseURL}/new-conversation`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    const data = await response.json();
                    if (data.conversation_id) {
                        this.currentConversationId = data.conversation_id;
                        const conversation = {
                            id: data.conversation_id,
                            title: `对话 ${this.conversations.length + 1}`,
                            messages: []
                        };
                        this.conversations.push(conversation);
                        return data.conversation_id;
                    } else {
                        throw new Error(data.error || '创建对话失败');
                    }
                } catch (error) {
                    console.error('创建新对话时出错:', error);
                    throw error;
                }
            }

            // 发送消息
            async sendMessage(message) {
                if (!this.currentConversationId) {
                    throw new Error('没有活动的对话');
                }

                const response = await fetch(`${this.baseURL}/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        conversation_id: this.currentConversationId,
                        message: message
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                return response;
            }

            // 上传文件
            async uploadFile(file, onProgress) {
                const formData = new FormData();
                formData.append('file', file);
                
                // 创建XMLHttpRequest以支持进度监控
                return new Promise((resolve, reject) => {
                    const xhr = new XMLHttpRequest();
                    
                    xhr.upload.addEventListener('progress', (event) => {
                        if (event.lengthComputable && onProgress) {
                            const percentComplete = (event.loaded / event.total) * 100;
                            onProgress(percentComplete);
                        }
                    });
                    
                    xhr.addEventListener('load', () => {
                        if (xhr.status === 200) {
                            try {
                                const data = JSON.parse(xhr.responseText);
                                resolve(data);
                            } catch (e) {
                                reject(new Error('解析响应失败'));
                            }
                        } else {
                            reject(new Error(`上传失败: ${xhr.status}`));
                        }
                    });
                    
                    xhr.addEventListener('error', () => {
                        reject(new Error('网络错误'));
                    });
                    
                    xhr.open('POST', `${this.baseURL}/upload`);
                    xhr.send(formData);
                });
            }

            // 获取任务状态
            async getTaskStatus(taskId) {
                try {
                    const response = await fetch(`${this.baseURL}/task/${taskId}`);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return await response.json();
                } catch (error) {
                    console.error('获取任务状态失败:', error);
                    throw error;
                }
            }

            // 流式获取分析结果
            async streamAnalysisResult(conversationId) {
                const response = await fetch(`${this.baseURL}/analyze-stream/${conversationId}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response;
            }

            // 轮询任务状态
            async pollTaskStatus(taskId, onProgress, onComplete, onError) {
                const pollInterval = 1000; // 1秒轮询一次
                const maxAttempts = 300; // 最多轮询5分钟
                let attempts = 0;

                const poll = async () => {
                    try {
                        attempts++;
                        const taskStatus = await this.getTaskStatus(taskId);
                        
                        if (onProgress) {
                            onProgress(taskStatus);
                        }

                        if (taskStatus.status === 'completed') {
                            if (onComplete) {
                                onComplete(taskStatus);
                            }
                            return;
                        } else if (taskStatus.status === 'failed') {
                            if (onError) {
                                onError(new Error(taskStatus.error || '任务执行失败'));
                            }
                            return;
                        } else if (attempts >= maxAttempts) {
                            if (onError) {
                                onError(new Error('任务超时'));
                            }
                            return;
                        }

                        // 继续轮询
                        setTimeout(poll, pollInterval);
                    } catch (error) {
                        if (onError) {
                            onError(error);
                        }
                    }
                };

                poll();
            }
        }

        // 配置Markdown解析器
        marked.setOptions({
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    try {
                        return hljs.highlight(code, { language: lang }).value;
                    } catch (err) {}
                }
                return hljs.highlightAuto(code).value;
            },
            breaks: true,
            gfm: true
        });

        // 初始化API客户端
        const apiClient = new ApiClient();

        // DOM元素
        const newConversationBtn = document.getElementById('new-conversation');
        const conversationList = document.getElementById('conversation-list');
        const chatWindow = document.getElementById('chat-window');
        const messageBox = document.getElementById('message-box');
        const sendBtn = document.getElementById('send-btn');
        const fileInput = document.getElementById('file-input');
        const filePreview = document.getElementById('file-preview');
        const statusIndicator = document.getElementById('status-indicator');

        // 检测内容是否包含Markdown格式
        function hasMarkdownSyntax(content) {
            const markdownPatterns = [
                /^#{1,6}\s+/m,           // 标题
                /\*\*.*?\*\*/,           // 粗体
                /\*.*?\*/,               // 斜体
                /`.*?`/,                 // 行内代码
                /```[\s\S]*?```/,        // 代码块
                /^\s*[-*+]\s+/m,         // 无序列表
                /^\s*\d+\.\s+/m,         // 有序列表
                /^\s*>\s+/m,             // 引用
                /\[.*?\]\(.*?\)/,        // 链接
                /\|.*?\|/,               // 表格
                /^---+$/m                // 分隔线
            ];
            
            return markdownPatterns.some(pattern => pattern.test(content));
        }

        // 显示消息（支持Markdown渲染）
        function displayMessage(role, content) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');
            messageDiv.classList.add(`${role}-message`);
            
            // 检测是否需要Markdown渲染
            if (hasMarkdownSyntax(content) || role === 'assistant') {
                // 使用Markdown渲染
                messageDiv.classList.add('markdown-content');
                messageDiv.innerHTML = marked.parse(content);
                
                // 高亮代码块
                messageDiv.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightElement(block);
                });
            } else {
                // 使用纯文本显示
                messageDiv.textContent = content;
            }
            
            chatWindow.appendChild(messageDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight;
            return messageDiv;
        }

        // 更新消息内容（用于流式更新）
        function updateMessageContent(messageDiv, content, isComplete = false) {
            const role = messageDiv.classList.contains('user-message') ? 'user' : 
                        messageDiv.classList.contains('assistant-message') ? 'assistant' : 'system';
            
            // 对于AI回复，总是使用Markdown渲染
            if (role === 'assistant' || hasMarkdownSyntax(content)) {
                if (!messageDiv.classList.contains('markdown-content')) {
                    messageDiv.classList.add('markdown-content');
                }
                
                // 如果内容还在更新中，先显示纯文本避免频繁重新渲染
                if (!isComplete && content.length > 0) {
                    messageDiv.textContent = content;
                } else {
                    // 完成时进行Markdown渲染
                    messageDiv.innerHTML = marked.parse(content);
                    
                    // 高亮代码块
                    messageDiv.querySelectorAll('pre code').forEach((block) => {
                        hljs.highlightElement(block);
                    });
                }
            } else {
                messageDiv.textContent = content;
            }
        }

        // 创建新对话
        async function createNewConversation() {
            try {
                const conversationId = await apiClient.startNewConversation();
                updateConversationList();
            } catch (error) {
                displayMessage('system', '创建新对话时出错: ' + error.message);
            }
        }

        // 更新对话列表
        function updateConversationList() {
            conversationList.innerHTML = '';
            apiClient.conversations.forEach(conversation => {
                const item = document.createElement('div');
                item.classList.add('conversation-item');
                if (conversation.id === apiClient.currentConversationId) {
                    item.classList.add('active');
                }
                item.textContent = conversation.title;
                item.addEventListener('click', () => {
                    apiClient.currentConversationId = conversation.id;
                    loadConversation(conversation);
                    updateConversationList();
                });
                conversationList.appendChild(item);
            });
        }

        // 加载对话
        function loadConversation(conversation) {
            chatWindow.innerHTML = '';
            conversation.messages.forEach(msg => {
                displayMessage(msg.role, msg.content);
            });
        }

        // 发送消息
        async function sendMessage() {
            const message = messageBox.value.trim();
            if (!message) return;
            
            // 显示用户消息
            displayMessage('user', message);
            
            // 清空输入框
            messageBox.value = '';
            
            // 显示状态指示器
            statusIndicator.style.display = 'block';
            chatWindow.scrollTop = chatWindow.scrollHeight;
            
            try {
                // 发送消息并获取回复
                const response = await apiClient.sendMessage(message);
                
                // 创建AI回复消息容器
                const assistantMessageDiv = displayMessage('assistant', '');
                let fullResponse = '';
                
                // 处理流式响应
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value, { stream: true });
                    const lines = chunk.split('\n\n');
                    
                    for (const line of lines) {
                        if (!line.startsWith('data: ')) continue;
                        
                        try {
                            const data = JSON.parse(line.slice(6));
                            
                            if (data.content) {
                                fullResponse += data.content;
                                updateMessageContent(assistantMessageDiv, fullResponse, false);
                                chatWindow.scrollTop = chatWindow.scrollHeight;
                            } else if (data.error) {
                                throw new Error(data.error);
                            } else if (data.done) {
                                // 对话完成，进行最终的Markdown渲染
                                updateMessageContent(assistantMessageDiv, fullResponse, true);
                                break;
                            }
                        } catch (e) {
                            console.error('解析流数据时出错:', e);
                        }
                    }
                }
                
                // 隐藏状态指示器
                statusIndicator.style.display = 'none';
                
                // 更新对话历史
                if (apiClient.currentConversationId) {
                    const conversation = apiClient.conversations.find(
                        c => c.id === apiClient.currentConversationId
                    );
                    if (conversation) {
                        conversation.messages.push(
                            { role: 'user', content: message },
                            { role: 'assistant', content: fullResponse }
                        );
                    }
                }
            } catch (error) {
                // 隐藏状态指示器
                statusIndicator.style.display = 'none';
                displayMessage('system', '发送消息时出错: ' + error.message);
            }
        }

        // 事件监听器
        newConversationBtn.addEventListener('click', createNewConversation);

        sendBtn.addEventListener('click', sendMessage);

        messageBox.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            // 检查文件类型
            const allowedTypes = ['txt', 'pdf', 'docx', 'doc', 'md'];
            const fileExt = file.name.split('.').pop().toLowerCase();
            if (!allowedTypes.includes(fileExt)) {
                filePreview.innerHTML = `不支持的文件类型。支持的类型: ${allowedTypes.join(', ')}`;
                displayMessage('system', `不支持的文件类型: ${fileExt}`);
                return;
            }
            
            // 检查文件大小 (16MB)
            if (file.size > 16 * 1024 * 1024) {
                filePreview.innerHTML = '文件太大，最大支持16MB';
                displayMessage('system', '文件太大，最大支持16MB');
                return;
            }
            
            // 显示上传进度条
            filePreview.innerHTML = `
                <div>正在上传: ${file.name}</div>
                <div class="progress-bar-container" style="width: 100%; height: 10px; background: #eee; border-radius: 5px; margin-top: 5px;">
                    <div class="progress-bar" style="height: 100%; background: #007bff; width: 0%; border-radius: 5px; transition: width 0.3s;"></div>
                </div>
            `;
            
            try {
                const result = await apiClient.uploadFile(file, (progress) => {
                    // 更新上传进度条
                    const progressBar = filePreview.querySelector('.progress-bar');
                    if (progressBar) {
                        progressBar.style.width = `${progress}%`;
                    }
                });
                
                displayMessage('system', `文件已上传: ${result.filename}`);
                
                // 如果成功提取到文件内容且有任务ID，开始异步处理
                if (result.has_content && result.task_id && result.conversation_id) {
                    // 切换到新对话
                    apiClient.currentConversationId = result.conversation_id;
                    const conversation = {
                        id: result.conversation_id,
                        title: `文件分析: ${file.name}`,
                        messages: []
                    };
                    apiClient.conversations.push(conversation);
                    updateConversationList();
                    
                    // 清空当前聊天窗口
                    chatWindow.innerHTML = '';
                    
                    displayMessage('system', `已自动创建新对话，正在分析文件内容...`);
                    displayMessage('user', `请分析以下教材内容:\n\n${result.content_preview || '文件内容已上传'}`);
                    
                    // 显示分析进度
                    filePreview.innerHTML = `
                        <div>分析中: ${result.filename}</div>
                        <div class="analysis-progress" style="width: 100%; height: 10px; background: #eee; border-radius: 5px; margin-top: 5px;">
                            <div class="analysis-bar" style="height: 100%; background: #28a745; width: 0%; border-radius: 5px; transition: width 0.3s;"></div>
                        </div>
                        <div class="analysis-status">正在分析文件内容...</div>
                    `;
                    
                    // 显示正在分析的状态
                    statusIndicator.style.display = 'block';
                    
                    // 开始轮询任务状态
                    apiClient.pollTaskStatus(
                        result.task_id,
                        // 进度更新回调
                        (taskStatus) => {
                            const analysisBar = filePreview.querySelector('.analysis-bar');
                            const analysisStatus = filePreview.querySelector('.analysis-status');
                            if (analysisBar) {
                                analysisBar.style.width = `${taskStatus.progress}%`;
                            }
                            if (analysisStatus) {
                                analysisStatus.textContent = `分析进度: ${taskStatus.progress}%`;
                            }
                        },
                        // 完成回调
                        async (taskStatus) => {
                            // 隐藏状态指示器
                            statusIndicator.style.display = 'none';
                            
                            // 更新文件预览状态
                            filePreview.innerHTML = `
                                <div>分析完成: ${result.filename}</div>
                                <div class="file-info">✓ AI分析已完成</div>
                            `;
                            
                            displayMessage('system', '文件分析完成，开始显示AI回复...');
                            
                            try {
                                // 获取并显示分析结果
                                const streamResponse = await apiClient.streamAnalysisResult(result.conversation_id);
                                
                                // 创建AI回复消息容器
                                const assistantMessageDiv = displayMessage('assistant', '');
                                let fullResponse = '';
                                
                                // 处理流式响应
                                const reader = streamResponse.body.getReader();
                                const decoder = new TextDecoder();
                                
                                while (true) {
                                    const { done, value } = await reader.read();
                                    if (done) break;
                                    
                                    const chunk = decoder.decode(value, { stream: true });
                                    const lines = chunk.split('\n\n');
                                    
                                    for (const line of lines) {
                                        if (!line.startsWith('data: ')) continue;
                                        
                                        try {
                                            const data = JSON.parse(line.slice(6));
                                            
                                            if (data.content) {
                                                fullResponse += data.content;
                                                assistantMessageDiv.textContent = fullResponse;
                                                chatWindow.scrollTop = chatWindow.scrollHeight;
                                            } else if (data.error) {
                                                throw new Error(data.error);
                                            } else if (data.done) {
                                                break;
                                            }
                                        } catch (e) {
                                            console.error('解析流数据时出错:', e);
                                        }
                                    }
                                }
                                
                                // 更新对话历史
                                conversation.messages.push(
                                    { role: 'user', content: `请分析以下教材内容:\n\n${result.content_preview || '文件内容已上传'}` },
                                    { role: 'assistant', content: fullResponse }
                                );
                                
                            } catch (error) {
                                displayMessage('system', '获取分析结果时出错: ' + error.message);
                            }
                        },
                        // 错误回调
                        (error) => {
                            statusIndicator.style.display = 'none';
                            filePreview.innerHTML = `
                                <div>分析失败: ${result.filename}</div>
                                <div class="file-info">❌ ${error.message}</div>
                            `;
                            displayMessage('system', '文件分析失败: ' + error.message);
                        }
                    );
                    
                } else if (!result.has_content) {
                    filePreview.innerHTML = `
                        <div>上传成功: ${result.filename}</div>
                        <div class="file-info">⚠ 未能提取文本内容</div>
                    `;
                    displayMessage('system', '文件上传成功，但未能提取到文本内容。请确保文件格式正确且包含文本内容。');
                } else {
                    // 同步处理完成的情况
                    filePreview.innerHTML = `
                        <div>处理完成: ${result.filename}</div>
                        <div class="file-info">✓ 已完成处理</div>
                    `;
                }
                
            } catch (error) {
                filePreview.innerHTML = `上传失败: ${error.message}`;
                displayMessage('system', '文件上传失败: ' + error.message);
            } finally {
                // 清空文件输入
                fileInput.value = '';
            }
        });

        // 滚动控制功能
        function initScrollControls() {
            const scrollToTopBtn = document.getElementById('scroll-to-top');
            const scrollToBottomBtn = document.getElementById('scroll-to-bottom');
            
            // 滚动到顶部
            function scrollToTop() {
                chatWindow.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
            }
            
            // 滚动到底部
            function scrollToBottom() {
                chatWindow.scrollTo({
                    top: chatWindow.scrollHeight,
                    behavior: 'smooth'
                });
            }
            
            // 绑定按钮事件
            scrollToTopBtn.addEventListener('click', scrollToTop);
            scrollToBottomBtn.addEventListener('click', scrollToBottom);
            
            // 键盘快捷键
            document.addEventListener('keydown', (e) => {
                // Ctrl+Home: 滚动到顶部
                if (e.ctrlKey && e.key === 'Home') {
                    e.preventDefault();
                    scrollToTop();
                }
                // Ctrl+End: 滚动到底部
                else if (e.ctrlKey && e.key === 'End') {
                    e.preventDefault();
                    scrollToBottom();
                }
                // Page Up: 向上滚动一页
                else if (e.key === 'PageUp' && chatWindow === document.activeElement) {
                    e.preventDefault();
                    chatWindow.scrollBy({
                        top: -chatWindow.clientHeight * 0.8,
                        behavior: 'smooth'
                    });
                }
                // Page Down: 向下滚动一页
                else if (e.key === 'PageDown' && chatWindow === document.activeElement) {
                    e.preventDefault();
                    chatWindow.scrollBy({
                        top: chatWindow.clientHeight * 0.8,
                        behavior: 'smooth'
                    });
                }
            });
            
            // 动态显示/隐藏滚动按钮
            function updateScrollButtons() {
                const isAtTop = chatWindow.scrollTop <= 10;
                const isAtBottom = chatWindow.scrollTop >= chatWindow.scrollHeight - chatWindow.clientHeight - 10;
                
                // 根据滚动位置调整按钮透明度
                scrollToTopBtn.style.opacity = isAtTop ? '0.3' : '0.8';
                scrollToBottomBtn.style.opacity = isAtBottom ? '0.3' : '0.8';
                
                // 禁用已到达位置的按钮
                scrollToTopBtn.disabled = isAtTop;
                scrollToBottomBtn.disabled = isAtBottom;
            }
            
            // 监听滚动事件
            chatWindow.addEventListener('scroll', updateScrollButtons);
            
            // 初始化按钮状态
            updateScrollButtons();
        }

        // 增强的消息显示函数，支持自动滚动控制
        function displayMessageWithScroll(role, content, autoScroll = true) {
            const messageDiv = displayMessage(role, content);
            
            // 如果启用自动滚动且用户接近底部，则自动滚动到底部
            if (autoScroll) {
                const isNearBottom = chatWindow.scrollTop >= chatWindow.scrollHeight - chatWindow.clientHeight - 100;
                if (isNearBottom) {
                    setTimeout(() => {
                        chatWindow.scrollTop = chatWindow.scrollHeight;
                    }, 100);
                }
            }
            
            return messageDiv;
        }

        // 初始化
        createNewConversation();
        initScrollControls();
    </script>
</body>
</html>
